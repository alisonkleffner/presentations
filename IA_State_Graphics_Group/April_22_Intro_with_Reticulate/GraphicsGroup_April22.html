<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Using Python in R with the Reticulate Pkg &amp; Integration with Shiny</title>
    <meta charset="utf-8" />
    <meta name="author" content="Alison Kleffner" />
    <meta name="date" content="2022-04-28" />
    <script src="libs/header-attrs-2.11/header-attrs.js"></script>
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/default-fonts.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Using Python in R with the Reticulate Pkg &amp; Integration with Shiny
### Alison Kleffner
### 2022-04-28

---




## Outline

1. Overall Problem 
  + Background Information
  + Why this application is being created
2. Process of App Development
  + Creation of User Interface
  + Replication of Python App with the Reticulate Package=
  + Replication of R Markdown code
3. Shiny App Walkthrough
  
---

## Data Intensive Farm Managment Project (DIFM)

+ Precision Agriculture research seeks to develop new strategies to increase crop yield and profitability [[Source]](https://sustainableamerica.org/blog/what-is-precision-agriculture/)

+ Experiments on strategies can be conducted through on-farm networks, which involves farmers conducting experiments under local conditions

  - Generates site-specific data for crop yield for different inputs (think like treatments)

+ DIFM is a grant with the funding going towards running these on-farm precision experiments and developing infrastructure to do so.

---

## So What am I Doing?

+ Create a R Shiny application that will create the experimental design based on site-specific inputs the farmer enters.
  - Backend code is written in both R and Python (depends on the crop)
+ Farmer will enter inputs:
  - File that contains the coordinates of their field boundary
  - How big they desire their experimental plots to be
  - What treatment they desire to use and the different rates
  - Specifics about their tractor
  - Ab-line file 
+ Farmers will receive:
  + shp and ab-line files that they can put in their tractor in order to enact the experimental design on their field.
  
---

## End Goal

+ Eventually hook app up to their database and after harvest, crop yields can be matched with the corresponding farm and it's design.

+ Then the data can begin to be analyzed to hopefully aid in the development of strategies to increase profitability
---

## Outline of Developement Process

+ At first, goal was to Replicate a Python App already in use in Shiny
  - Start be creating UI similar to Python app
  - Connect R and Python
  - Figure out how to run the Python files
  - Find out later, best used for wheat field trials
+ Add R Markdown code to create design for corn/soybean trials

---

## Python App for Wheat Field Trials

[Python App Trying to Replicate](http://trialdesign.difm-cig.org/demo)

&lt;div class="figure" style="text-align: center"&gt;
&lt;img src="C:/Users/akleffner2/OneDrive - University of Nebraska-Lincoln/Pictures/Screenshots/Simplefield_py.png" alt="Python App Output" width="90%" height="90%" /&gt;
&lt;p class="caption"&gt;Python App Output&lt;/p&gt;
&lt;/div&gt;

---

## Replicating Python App in Shiny - Setting up UI

+ Setting up UI:
  - Create Leaflet map capability
  - Dialog Box for Inputs

&lt;div class="figure" style="text-align: center"&gt;
&lt;img src="C:/Users/akleffner2/OneDrive - University of Nebraska-Lincoln/Pictures/Screenshots/TDS4.png" alt="Initial App" width="50%" height="90%" /&gt;&lt;img src="C:/Users/akleffner2/OneDrive - University of Nebraska-Lincoln/Pictures/Screenshots/TDS2.png" alt="Initial App" width="50%" height="90%" /&gt;
&lt;p class="caption"&gt;Initial App&lt;/p&gt;
&lt;/div&gt;

---

## Add in Python Capability using Reticulate

+ What is Reticulate?
  - Let's say you are working on project where you need to use a mix of R and Python Functions

  - This package creates a R Interaface to Python and allows you to "easily" go back and forth between the two of them.
  
  - [Reticulate Website](https://rstudio.github.io/reticulate/index.html)

---

## What can Reticulate Do?

- Call Python from R in different ways

  + Source a Python script 
  
  + Use in R Markdown and R Shiny
  
  + Import Python modules
  
- Translate between R and Python Objects

- Create Python Virtual environments 

---

## Creating A Python Virtual Environment

If you are working on a project, you may want to create a python virtual environment (creates an isolated version of Python)

[Configuring a virtual environment from reticulate website](https://rstudio.github.io/reticulate/articles/versions.html)

[Basic Outline on how I did it](https://medium.com/co-learning-lounge/create-virtual-environment-python-windows-2021-d947c3a3ca78) (on Windows):
+ Create a Project in R Studio (File -&gt; New Project)
+ Have Python installed on your computer
+ In Anaconda Prompt
 - conda create --name [Virtual Environment Name] python=[Version you want to install]
 - conda activate [Virtual Environment Name]
 - load all necessary Python packages in here (conda install pkge)
+ In R Studio, connect to Python Virtual Environment 
  + Tools -&gt; Project Options -&gt; Python -&gt; Conda Environments
+ Check connection using: py_config()

---

## Complications with Reticulate

1. Installing Packages: [Requirements List](C:/Users/akleffner2/OneDrive - University of Nebraska-Lincoln/Documents/PrescriptionShinyTool/requirements.txt)
  - Had issues trying to install at once - install in chunks
  - Some packages required a wheel to be installed
  - Some packages would not install with pip command (would get a Windows Visual Studio Error) - but installing packages with conda worked 
  
2. Connecting Python
  - Kept trying to connect with a version of Python no longer installed on my machine
  - Solution: Installed an older version of Reticulate (Version 1.16-9000)

---

## Python Finally Connected to R: Now get Code to Run

+ Had Python files, so sourced them in app in order to get functions available. 
  - [source_python('field_creation.py')](C:/Users/akleffner2/OneDrive - University of Nebraska-Lincoln/Documents/PrescriptionShinyTool/UI/field_creation.py)
+ Created a list of Shiny Inputs that can pass into Python
+ Helpful Tip: Worked through getting Python code to run in just a R Script first
+ Ran below code to run the necessary Python code in the file


```r
result &lt;- Field(id = 0, field_dict=field_dict) #main python class

result$create_field() #actual function to run (creates the field object)
```

---

## Python Output

&lt;div class="figure" style="text-align: center"&gt;
&lt;img src="C:/Users/akleffner2/OneDrive - University of Nebraska-Lincoln/Pictures/Screenshots/plotwithvalues.png" alt="Trial Design Output" width="100%" height="100%" /&gt;
&lt;p class="caption"&gt;Trial Design Output&lt;/p&gt;
&lt;/div&gt;

---

## Adding in Downloading Capabilities

&lt;div class="figure" style="text-align: center"&gt;
&lt;img src="C:/Users/akleffner2/OneDrive - University of Nebraska-Lincoln/Pictures/Screenshots/TDS3.png" alt="Download Tab" width="70%" height="70%" /&gt;
&lt;p class="caption"&gt;Download Tab&lt;/p&gt;
&lt;/div&gt;

+ Files were created in a different file:
  - [source_python('fileIO.py')](C:/Users/akleffner2/OneDrive - University of Nebraska-Lincoln/Documents/PrescriptionShinyTool/UI/fileIO.py)
  

```r
req(filesDLD()) #reactive value for result object
write_map_to_files('prescription_map', field_ = filesDLD())
```

  
---

## R Markdown Code for Corn and Soybean Field Trials

+ Next code for creating Corn and Soybean field trials needed to be added to the app
+ Luckily this code was in R Markdown files
+ [Example](C:/Users/akleffner2/Downloads/make_trial_design.html)
+ Now selecting desired crop will dictate which form is received and what field creation code will be ran
+ Working, but needs a lot of cleaning up

&lt;div class="figure" style="text-align: center"&gt;
&lt;img src="C:/Users/akleffner2/OneDrive - University of Nebraska-Lincoln/Pictures/Screenshots/choose_crop.png" alt="Choosing Crop" width="70%" height="70%" /&gt;
&lt;p class="caption"&gt;Choosing Crop&lt;/p&gt;
&lt;/div&gt;

---

## Now let's Actually Go to the App!

---

## Next Steps: App Beautification

+ Leaflet map for Corn/Soybean Code
+ Cleaning of Corn/Soybean Inputs
+ Layout of maps 
+ Testing to make sure code is working properly
+ Error handling for inputs 

---

## Questions?





    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
